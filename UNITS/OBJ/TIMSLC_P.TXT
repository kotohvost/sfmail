
                 GENERIC TIMESLICE SERVER V1.12c

!!25.09.96!! Возможна была бага при проигрывании звуков - если работали
под OS/2 могло ошибочно вызыватся проигрывание звуков для DesQ

!!16.09.96!! Добавлено распознавание Linux DOSemu. Тоесть теперь
мы определяем что мы работаем в дос боксе Linux а также умеем изменять
время забираемое у процессора ("hogthreshold"). Отдача времени
производится через HLT. Значение по умолчанию 50h и его можно изменять
от 00h до 99h.

!!21.04.96!! Добавлено распознавание WIN95/NT и отдельно распозанется
WIN или GENERIC отдача то есть 1680h. Поменялось значение битов!!
Все изменения внесены в RelTQ.pas

!!4.05.95!! Оптимизирована DoDelay а также убраны команды STI перед HLT
это немного рискованно,  но зависнуть может только при запрещенных
прерываниях а такое может быть только при ошибках операционки так
как мы не вызываем ReleaseTQ при запрещенных прерываниях.
Также исправлена бага с IPX приводившая к зависанию.
Также исправлена бага с RTS-386 приводившая либо к зависанию либо
к большим задержкам.

!!29.04.95!! Оптимизирована функция DoDelay под OS/2, RTS386 и EMSDOS 4.0
!!23.04.95!!! Новые функция MSound и DoDelay
!!!!NOTE!!! Изменился формат OSword возвращаемый функцией GetOS
!!!!NOTE!!! Изменился тип результата возвращаемый GetOS
!!!!NOTE!!! Смотри описание GetOS и OSword

╔══════════════════════════════════════════════════════════════╗
║ Полное  описание  интерфейса  функций  смотри   в   конце.   ║
╚══════════════════════════════════════════════════════════════╝

     Сие произведение служит для окультуривания нашего мэйлера  -
так как культурные люди включают поддержку мультитаскеров в  свои
программы.

     В файле находится пять функций

     interface
     function GetOS():longint
     function ChangeTQ(TQ:word):boolean
     function SetDefault():boolean
     function ChangeOSword(OSword:word):boolean
     function ReleaseTQ():boolean
     function GetVirtualScreen(pScreen:pointer):pointer
     function MSound(Frequency:word; Duration:word):boolean
     function DoDelay(wDelay:word):boolean;external

     Первая функция возвращает двойное слово.  Старшее слово  это
версия операционной системы.  Тоесть младший байт этого слова это
младшая часть версии,  а старший байт это старшая  часть  версии.
Например:

     Возвращено число $31E оно расшифровывается как версия 3.30

     Младшее слово представляет  собой  битовую  запись  (record)
длиной 16 бит, в которой пока определены следующие биты:

     бит 0 : OS/2
     бит 1 : Desq
     бит 2 : PC-MOS/386
     бит 3 : Generic time slice service 1680h int2fh
     бит 4 : Windows 3.1x  (версия возвращается)
     бит 5 : Windows'95/NT
     бит 6 : Eropean MS-DOS 4.0
     бит 7 : MS-DOS 5 or above
     бит 8 : DoubleDos
     бит 9 : RTS-386
     бит 10: HLT
     бит 11: IPX Relinquish
     бит 12: Undefined (Int 28h)
     бит 13: Linux DOSemu

     Причем одновременно может быть установлен только  один  бит.
Если не обнаружено известного мультитаскера,  то  устанавливается
бит 12.
     Что касается бита 10, то он не устанавливается этой функцией.
Этот бит может быть  установлен  функцией  CnahgeOSword,  в  этом
случае для отдачи времени будет использоваться  команда  HLT. Эта
функция(GetOS)  должна  быть  вызвана   ОБЯЗАТЕЛЬНО   до   вызова
следующих.  Функция ChangeTQ  или  если  полностью  "Change  Time
Quant"  позволяет  изменять  время  отдаваемое  системе  (в   тех
мультитаскерах  которые  это  позволяют).   В  результате   можно
оптимально настроить взаимодействие мэйлера и мультитаскера.  Это
позволяет OS/2,  DoubleDos,  PC-MOS/386 и MS-DOS 4.0  В  качестве
параметра  должен   передаваться   байт   содержащий   количество
миллисекунд.

     Третья функция(ReleaseTQ) это и есть освободитель времени  и
ее вызов нужно вставить во все циклы ожидания.
     Функции  ChangeTQ,  ReleaseTQ,   ChangeOSword  и  SetDefault
возвращают  буллевское  значение  -   True   или   False.   False
возвращается в том случае,  если в начале не была вызвана функция
GetOS, в этом случае функции не производят ни каких действий.

     Четвертая функция ChangeOSword  служит  для  того  чтобы  вы
могли поменять способ отдачи времени  по  своему  усмотрению,  то
есть  проигнорировав  установки  сделанные  функцией  GetOS.   Ну
например умный пользователь мог бы менять это в конфиге.  Функции
в качестве аргумента передается слово (битовая  запись)  того  же
формата,  что и возвращаемое функцией  GetOS.  Чтобы  форсировать
какой  либо  способ  отдачи  времени,   нужно  просто  чтоб   был
установлен соответствующий бит. Функция возвращает True/False.

     Пятая функция SetDefault  устанавливает  размер  отдаваемого
кванта  по  умолчанию.   Эта  функция  также   вызывается   самой
библиотекой из функция GetOS и ChangeOSword. Поэтому после вызова
этих функций если вы  хотите  поставить  другие  значения  то  вы
должны вызвать ChangeTQ(значения сбрасываются в "default").


     Шестая функция GetVirtualScreen служит для получения  адреса
виртуального экрана под  мультитаскерами.  В  качестве  параметра
принимает указатель на текущий видеоэкран то есть то  куда  пишем
обычно под досом (B000:0000,  B800:0000,  A000:0000) А возвращает
указатель на виртуальный экран .  Если вы пишите  на  виртуальный
экран  скорость  работы  мультитаскера  возрастает  так  как   не
возникает exeptions и их обработки.
     Данная функция возвращает адрес экрана только под  DoubleDos
и DesQ  так  как  способы  получения  этого  адреса  под  другими
мультитаскерами мне неизвестны.  Но вы можете не обращать на  это
внимание так как  в  этих  случаях  переданный  в  функцию  адрес
возвращается без изменения.

     Седьмая  функция  MSound  служит  для  генерации  звука.  Эта
функция  использует  для  генерации  звука  встроенные   средства
операционок.  В случае Доса и тех  операционок  которые  не  дают
таких средств,  производится вызов  паскалевских  функций  Sound,
NoSound, Delay.
     Частота задается в герцах (аргумент Frequency),  а  время  в
миллисекундах(аргумент Duration).
     Если  не  была  инициализирована  библиотека  то  возвращает
значение False.

     Восьмая функция DoDelay предназначена для замены стандартной
функции Delay .  Это нужно потому что стандартная  функция  Delay
ест процессорное время.  Аргумент это слово содержащее задержку в
миллисекундах, тоесть максимум 65535.
     Если  не  была  инициализирована  библиотека  то  возвращает
значение False.


     Время задается в миллисекундах для операционок OS/2, Eropean
MS-DOS 4.0 и RTS-386.Для операционок PC-MOS и DoubleDos оно  тоже
задается в миллисекундах,  но с шагом в 55 mS (тоесть  вы  можете
задать любое значение - функция ChangeTQ сама все преобразует). В
остальных  операционках  число  "TimeQuant"  не   имеет   прямого
отношения к времени(зависит от установок операционки, например, в
Виндоуз зависит от параметра MinTimeSlice в файле System.Ini),  а
обозначает некоторую абстрактную величину - чем  она  больше  тем
меньше времени процессора берет себе задача.

                      Значения по умолчанию

     Windows - 255
     Generic - 255
     OS/2 - 55 mS
     PC-MOS - 55 mS
     DoubleDos - 55 mS
     MS-DOS 4.0 - 55 mS
     RTS-386 - 55 mS
     DESQ - 255
     HLT - 255
     IPX - 255
     INT28 - 255
     MS-DOS 5.0+ - 255
     Linux DOSemu - 80


     Все отлинковано для модели TPASCAL и  должно  линковаться  с
ПАскалем так чтобы эти функции вызывались как дальние.


                             ФУНКЦИИ

────────────────────────────────────────────────────────────────────────────
     GetOS
     функция возвращает двойное слово - старшее слово это  версия
операционной системы,  а младшее это битовая запись,  где  каждый
бит обозначает операционную систему.  В битовой записи  не  может
быть установленно одновременно более одного бита.

     NOTE!! После вызова функции количество времени отдаваемое за
один  вызов  функции  ReleaseTQ(см.   ниже)   устанавливается   в
дефолтное значение(см. функцию SetDefault).

     NOTE!! Данная функция должна быть вызвана  ДО  вызова  любых
других функций библиотеки.


     function GetOS:integer;external

     OsIDword

     бит 0 : OS/2
     бит 1 : Desq
     бит 2 : PC-MOS/386
     бит 3 : Generic time slice service 1680h int2fh
     бит 4 : Windows 3.1x  (версия возвращается)
     бит 5 : Windows'95/NT
     бит 6 : Eropean MS-DOS 4.0
     бит 7 : MS-DOS 5 or above
     бит 8 : DoubleDos
     бит 9 : RTS-386
     бит 10: HLT
     бит 11: IPX Relinquish
     бит 12: Undefined (Int 28h)
     бит 13: Linux DOSemu

     Бит 10  может  быть  установлен  только   принудительно.(см.
функцию ChangeOSword).
     Бит 12 устанавливается  если  функция  не  смогла  определить
метод отдачи процессорного времени.

     Example:
     OsIDword:=GetOS;

──────────────────────────────────────────────────────────────────────────

     ChangeTQ
     функция изменяет текущее  значение  размера  кванта  времени
отдаваемого за один вызов функции ReleaseTQ.

     NOTE!!! В случае если эта функция вызвана до функции  GetOS,
то никаких действий не производится, и функция возвращает False.

     function ChangeOSword(TQ:word):boolean;external;

     TQ - время в миллисекундах для:

     OS/2
     PC-MOS/386
     Eropean MS-DOS 4.0
     DoubleDos
     RTS-386

     NOTE!!! Для PC-MOS и DoubleDos шаг составляет 55 mS,  но  об
этом можно не заботится -  функция  сама  производит  необходимые
вычисления.

     TQ - абстрактная величина для:

     Desq
     Windows
     Generic TSlice service (int2f)
     MS-DOS 5 or above
     HLT
     IPX
     Undefined (Int 28h)
     Linux DOSemu

     Определяет интенсивность  вызова  системных  функций  отдачи
времени.

───────────────────────────────────────────────────────────────────

     SetDefault
     Функция усианавливает значение TQ (см. предыдущую функуию) в
дефолт для выбранной операционки.

     NOTE!!! В случае если эта функция вызвана до функции  GetOS,
то никаких действий не производится, и функция возвращает False.

     function SetDefault:boolean;external;

     Дефолтные значения:

     OS/2 - 55 mS
     PC-MOS - 55 mS
     DoubleDos - 55 mS
     MS-DOS 4.0 - 55 mS
     RTS-386 - 55 mS
     Windows - 255
     Genneric - 255
     DESQ - 255
     HLT - 255
     IPX - 255
     INT28 - 255
     MS-DOS 5.0+ - 255
     Linux DOSemu - 80

─────────────────────────────────────────────────────────────────────────

     ChangeOSword
     Функция   принудительно   устаналивает   флаг   операционной
ситемы(устанавливается только один флаг - см. GetOS).

     NOTE!!! В случае если эта функция вызвана до функции  GetOS,
то никаких действий не производится, и функция возвращает False.
     Также False возвращается если  в  переданном  функции  слове
установлено более одного бита.

     function ChangeOSword(OSword:word):boolean;

     OSword
     смотри функцию GetOS

     NOTE!! Метод HLT (выполнение инструкции HLT) может быть  установлен
только с помощь этой функции.

───────────────────────────────────────────────────────────────────

     ReleaseTQ
     Функция  вызывает  системную  функцию   в   соответствии   с
установленным битом в OsIDword.

     NOTE!!! В случае если эта функция вызвана до функции  GetOS,
то никаких действий не производится, и функция возвращает False.

     function ReleaseTQ:boolean;external;

───────────────────────────────────────────────────────────────────

     GetVirtualScreen
     Функция возвращает адресс виртуального экрана мультитаскера.
     В качестве параметра функции  передается  адресс  в  формате
сегмент:смещение экрана куда сейчас производится вывод.
     B000:0000, B800:0000, A000:0000

     function GetVirtualScreen(pSreen:pointer):pointer;external

     Под операционками:

     DESQ
     DoubleDos
     Возвращается адресс виртуального экрана.

     Остальные - неизмененный адресс переданный функции.

────────────────────────────────────────────────────────────────────

     MSound

     function MSound(wFrequency:word; wDuration:word):boolean;external


     Функция MSound  служит  для  генерации  звука.  Эта  функция
использует для генерации звука встроенные средства операционок. В
случае Доса и тех операционок  которые  не  дают  таких  средств,
производится вызов паскалевских функций Sound,  NoSound из модуля
CRT. Или Си функции sound и nosound описанные в dos.h
     Частота задается в герцах (аргумент Frequency),  а  время  в
миллисекундах(аргумент Duration).
     Если частота равна нулю то будет выдержена пауза в звучании.
     Если и частота и время равны нулю, то произойдет полное вы-
ключение звука.
     Если  не  была  инициализирована  библиотека  то  возвращает
значение False.

────────────────────────────────────────────────────────────────────

     DoDelay

     function DoDelay(wDelay:word):boolean;external


     Функция DoDelay предназначена для замены стандартной функции
Delay .  Это нужно  потому  что  стандартная  функция  Delay  ест
процессорное время.  Аргумент это  слово  содержащее  задержку  в
миллисекундах,   тоесть  максимум  65535.
     Если  не  была  инициализирована  библиотека  то  возвращает
значение False.

────────────────────────────────────────────────────────────────────

     18.01.95
     Вадим Барановский Santa-Fox Team.

